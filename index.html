<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’å…¥æ’åºæ³•å¤§æŒ‘æˆ° | Insertion Sort Challenge V0122.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .card-shadow { box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.2); }
        .card-active { transform: translateY(-10px) scale(1.05); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); border-color: #FBBF24; border-width: 4px; }
        .transition-all-300 { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        .slot-highlight { background-color: #FEF3C7; border: 2px dashed #F59E0B; }
        .sorted-bg { background-color: #D1FAE5; border: 2px solid #10B981; }
        .unsorted-bg { background-color: #F3F4F6; border: 2px dashed #9CA3AF; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 selection:bg-yellow-200">

    <!-- Navbar -->
    <nav class="bg-indigo-600 text-white p-4 sticky top-0 z-50 shadow-lg border-b-4 border-indigo-800">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="text-3xl">ğŸƒ</span>
                <h1 class="text-2xl font-black tracking-wider">æ’å…¥æ’åºæ³•å¤§æŒ‘æˆ°</h1>
            </div>
            <div class="flex gap-2 bg-indigo-700 p-1 rounded-lg">
                <button onclick="switchTab('learn')" id="btn-learn" class="tab-btn px-4 py-2 rounded font-bold transition-all bg-yellow-400 text-indigo-900 shadow-md transform scale-105">æ•™å­¸å€</button>
                <button onclick="switchTab('play')" id="btn-play" class="tab-btn px-4 py-2 rounded font-bold transition-all hover:bg-indigo-500 text-indigo-100">äº’å‹•é—–é—œ</button>
                <button onclick="switchTab('quiz')" id="btn-quiz" class="tab-btn px-4 py-2 rounded font-bold transition-all hover:bg-indigo-500 text-indigo-100">éš¨å ‚æ¸¬é©—</button>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-6 pb-20">

        <!-- SECTION 1: LEARN -->
        <div id="view-learn" class="view-section space-y-6">
            <!-- Concept Cards -->
            <div class="grid md:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-indigo-600 mb-2"><i data-lucide="brain-circuit" class="w-8 h-8"></i></div>
                    <h3 class="text-lg font-bold mb-2">ä»€éº¼æ˜¯æ’å…¥æ’åºï¼Ÿ</h3>
                    <p class="text-slate-600 text-sm leading-relaxed">å°±åƒæ•´ç†æ’²å…‹ç‰Œï¼æŠŠç‰Œåˆ†æˆã€Œå·²æ’åºã€å’Œã€Œæœªæ’åºã€ï¼Œæ¯æ¬¡æ‹¿ä¸€å¼µæœªæ’åºçš„ç‰Œï¼Œæ’é€²å·²æ’åºçš„æ­£ç¢ºä½ç½®ã€‚</p>
                </div>
                <div class="bg-white p-5 rounded-xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-pink-500 mb-2"><i data-lucide="list-ordered" class="w-8 h-8"></i></div>
                    <h3 class="text-lg font-bold mb-2">ä¸‰å¤§è¦å‰‡å£è¨£</h3>
                    <ol class="list-decimal list-inside text-slate-600 text-sm space-y-1">
                        <li><span class="font-bold text-emerald-600">æœ€å‰ç«¯</span>å…ˆç•¶å·²æ’åº</li>
                        <li>æ‹¿<span class="font-bold text-gray-500">æœªæ’åº</span>ç¬¬ 1 å€‹ç•¶ Key</li>
                        <li>å¾<span class="font-bold text-indigo-600">å³å¾€å·¦</span>æ¯”ï¼Œæ’é€²æ­£ç¢ºä½ç½®</li>
                    </ol>
                </div>
                <div class="bg-white p-5 rounded-xl border-2 border-indigo-100 shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-emerald-500 mb-2"><i data-lucide="play-circle" class="w-8 h-8"></i></div>
                    <h3 class="text-lg font-bold mb-2">æ¼”ç®—æ³•é‚è¼¯</h3>
                    <div class="bg-slate-800 text-green-400 p-3 rounded-lg text-xs font-mono overflow-x-auto leading-relaxed shadow-inner">
                        <p><span class="text-pink-400">for</span> i = 1 <span class="text-pink-400">to</span> n-1 <span class="text-slate-500">// å¾ç¬¬ 2 å¼µç‰Œé–‹å§‹</span></p>
                        <p class="pl-4">key = A[i] <span class="text-slate-500">// æ‹¿å‡ºé€™å¼µç‰Œ (Key)</span></p>
                        <p class="pl-4">j = i - 1 <span class="text-slate-500">// æº–å‚™è·Ÿå·¦é‚Šçš„æ¯”</span></p>
                        <p class="pl-4"><span class="text-pink-400">while</span> j >= 0 <span class="text-pink-400">and</span> A[j] > key</p>
                        <p class="pl-8">A[j+1] = A[j] <span class="text-slate-500">// æ¯” Key å¤§å°±å¾€å³ç§»</span></p>
                        <p class="pl-8">j = j - 1 <span class="text-slate-500">// å†çœ‹æ›´å·¦é‚Šé‚£å¼µ</span></p>
                        <p class="pl-4">A[j+1] = key <span class="text-slate-500">// æ‰¾åˆ°ä½ç½®ï¼Œæ’å…¥ï¼</span></p>
                    </div>
                </div>
            </div>

            <!-- Demo Stage -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-slate-200">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                        <i data-lucide="monitor-play"></i> 
                        å‹•ç•«æ¼”ç¤º (Demo)
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="resetDemo()" class="bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded text-sm font-bold text-slate-700 transition-colors">é‡æ–°é–‹å§‹</button>
                        <button id="demo-play-btn" onclick="toggleDemoAutoPlay()" class="bg-emerald-500 hover:bg-emerald-600 px-4 py-1 rounded text-sm font-bold text-white transition-colors flex items-center gap-1">
                            <i data-lucide="play" class="w-4 h-4"></i> æ’­æ”¾
                        </button>
                        <button onclick="stepDemo()" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded text-sm font-bold text-white transition-colors">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>

                <!-- Explanation Box -->
                <div id="demo-message" class="bg-amber-50 text-amber-800 p-3 rounded-lg border border-amber-200 mb-6 text-center font-bold text-lg min-h-[3.5rem] flex items-center justify-center">
                    æº–å‚™é–‹å§‹...
                </div>

                <!-- Visualization Area -->
                <div class="relative min-h-[200px] flex justify-center items-end pb-10 gap-2 md:gap-4 select-none" id="demo-container">
                    <!-- Cards will be injected here -->
                </div>

                <!-- Legend -->
                <div class="flex flex-wrap justify-center gap-4 mt-4 text-xs font-bold text-slate-500">
                    <div class="flex items-center gap-1"><div class="w-4 h-4 bg-emerald-100 border-2 border-emerald-500 rounded"></div> å·²æ’åºå€</div>
                    <div class="flex items-center gap-1"><div class="w-4 h-4 bg-white border-2 border-slate-300 rounded"></div> æœªæ’åºå€</div>
                    <div class="flex items-center gap-1"><div class="w-4 h-4 bg-yellow-100 border-2 border-yellow-500 rounded"></div> ç•¶å‰ Key</div>
                    <div class="flex items-center gap-1"><div class="w-4 h-4 bg-blue-100 border-2 border-blue-500 rounded"></div> æ¯”è¼ƒå°è±¡</div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: PLAY (INTERACTIVE) -->
        <div id="view-play" class="view-section hidden space-y-6">
            
            <!-- Mode Selection -->
            <div class="flex justify-center gap-4 mb-4">
                <button onclick="setGameMode('drag')" id="mode-drag" class="mode-btn px-6 py-3 rounded-xl border-b-4 border-indigo-800 bg-indigo-600 text-white font-bold text-lg hover:translate-y-1 transition-all shadow-lg w-1/2 md:w-auto active-mode ring-4 ring-offset-2 ring-indigo-300">
                    ç©æ³• A: æ‹–æ›³æ’å…¥
                </button>
                <button onclick="setGameMode('algo')" id="mode-algo" class="mode-btn px-6 py-3 rounded-xl border-b-4 border-slate-400 bg-slate-200 text-slate-600 font-bold text-lg hover:translate-y-1 transition-all shadow-lg w-1/2 md:w-auto">
                    ç©æ³• B: æ¼”ç®—æ³•ä¸‰éµ
                </button>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-slate-200 min-h-[400px]">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-700" id="game-title">æ‹–æ›³æŒ‘æˆ°</h2>
                        <p class="text-slate-500 text-sm" id="game-instruction">é»æ“Šé»ƒè‰² Keyï¼Œå†é»æ“Šç¶ è‰²å€åŸŸä¸­çš„æ­£ç¢ºç©ºä½æ’å…¥ã€‚</p>
                    </div>
                    <div class="flex gap-4 text-center">
                        <div class="bg-slate-100 p-2 rounded-lg min-w-[80px]">
                            <div class="text-xs text-slate-500 font-bold uppercase">Round</div>
                            <div class="text-xl font-black text-indigo-600" id="game-round">1/5</div>
                        </div>
                        <div class="bg-slate-100 p-2 rounded-lg min-w-[80px]">
                            <div class="text-xs text-slate-500 font-bold uppercase">Errors</div>
                            <div class="text-xl font-black text-red-500" id="game-errors">0</div>
                        </div>
                    </div>
                </div>

                <!-- Game Area -->
                <div id="game-container" class="relative bg-slate-50 rounded-xl border-2 border-slate-200 p-4 md:p-8 min-h-[250px] flex justify-center items-center gap-3">
                    <!-- Game elements injected here -->
                </div>

                <!-- Algo Mode Controls (Hidden by default) -->
                <div id="algo-controls" class="hidden mt-6 grid grid-cols-3 gap-4 max-w-lg mx-auto">
                    <button onclick="algoAction('compare')" class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl border-b-4 border-blue-700 transition-all flex flex-col items-center gap-1 group">
                        <i data-lucide="eye" class="group-hover:scale-110 transition-transform"></i>
                        1. æ¯”è¼ƒå·¦é‚Š
                    </button>
                    <button onclick="algoAction('shift')" class="bg-purple-500 hover:bg-purple-600 active:bg-purple-700 text-white font-bold py-3 px-4 rounded-xl border-b-4 border-purple-700 transition-all flex flex-col items-center gap-1 group">
                        <i data-lucide="arrow-right-circle" class="group-hover:scale-110 transition-transform"></i>
                        2. å³ç§»ä¸€æ ¼
                    </button>
                    <button onclick="algoAction('insert')" class="bg-emerald-500 hover:bg-emerald-600 active:bg-emerald-700 text-white font-bold py-3 px-4 rounded-xl border-b-4 border-emerald-700 transition-all flex flex-col items-center gap-1 group">
                        <i data-lucide="arrow-down-circle" class="group-hover:scale-110 transition-transform"></i>
                        3. æ’å…¥ Key
                    </button>
                </div>
                
                <div id="game-feedback" class="mt-4 text-center font-bold text-lg h-8 text-indigo-600"></div>
                
                <div class="mt-6 flex justify-center">
                     <button onclick="initGame()" class="bg-slate-800 text-white px-6 py-2 rounded-full font-bold hover:bg-slate-700 transition-colors shadow-lg flex items-center gap-2">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> é‡ç½®é—œå¡
                    </button>
                </div>
            </div>
        </div>

        <!-- SECTION 3: QUIZ (Student Info + 20 Questions) -->
        <div id="view-quiz" class="view-section hidden space-y-6">
            
            <!-- Student Login / Info -->
            <div id="student-login" class="bg-white p-8 rounded-2xl shadow-xl border-4 border-indigo-200 max-w-lg mx-auto">
                <h2 class="text-2xl font-black text-indigo-800 mb-6 text-center flex items-center justify-center gap-2">
                    <i data-lucide="user-circle-2"></i> å­¸ç”Ÿè³‡æ–™ç™»å…¥
                </h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-600 font-bold mb-1">ç­ç´š</label>
                        <input type="text" id="std-class" placeholder="ä¾‹ï¼š801" class="w-full p-3 border-2 border-slate-300 rounded-lg text-lg focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-slate-600 font-bold mb-1">åº§è™Ÿ</label>
                        <input type="number" id="std-num" placeholder="ä¾‹ï¼š05" class="w-full p-3 border-2 border-slate-300 rounded-lg text-lg focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-slate-600 font-bold mb-1">å§“å</label>
                        <input type="text" id="std-name" placeholder="ä¾‹ï¼šç‹å°æ˜" class="w-full p-3 border-2 border-slate-300 rounded-lg text-lg focus:border-indigo-500 outline-none">
                    </div>
                    <button onclick="startQuiz()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl text-xl hover:bg-indigo-700 transition-transform active:scale-95 shadow-lg mt-4">
                        é–‹å§‹æ¸¬é©—
                    </button>
                </div>
            </div>

            <!-- Quiz Content (Hidden initially) -->
            <div id="quiz-content" class="hidden space-y-8 max-w-3xl mx-auto">
                
                <!-- Info Bar -->
                <div class="bg-indigo-900 text-white p-4 rounded-xl flex justify-between items-center shadow-lg sticky top-20 z-40">
                    <div class="font-bold text-lg"><span id="display-std-info"></span></div>
                    <div class="text-yellow-400 font-mono font-bold" id="quiz-timer"></div>
                </div>

                <div id="quiz-questions-container" class="space-y-8">
                    <!-- Generated by JS -->
                </div>

                <div class="text-center pt-8 pb-12">
                    <button onclick="submitQuiz()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 px-12 rounded-full text-2xl shadow-xl transform transition-all hover:-translate-y-1 active:translate-y-0">
                        äº¤å·è¨ˆç®—æˆç¸¾
                    </button>
                </div>
            </div>

            <!-- Result Modal (Hidden) -->
            <div id="quiz-result" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 relative">
                    <button onclick="closeQuizResult()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                        <i data-lucide="x-circle" class="w-8 h-8"></i>
                    </button>
                    
                    <div class="text-center mb-6">
                        <h2 class="text-3xl font-black text-indigo-900 mb-2">æ¸¬é©—çµæœ</h2>
                        <div class="text-6xl font-black text-emerald-600 mb-2" id="final-score">0</div>
                        <p class="text-slate-500">åˆ†</p>
                    </div>

                    <div class="bg-slate-100 p-4 rounded-xl mb-6 font-mono text-sm break-all select-all cursor-pointer border-2 border-slate-300" id="result-code-box" onclick="copyResultCode()">
                        <!-- Result String -->
                    </div>
                    
                    <div class="text-center mb-6">
                        <p class="text-red-500 font-bold mb-2 text-sm">è«‹é»æ“Šä¸Šæ–¹æ–¹æ¡†è¤‡è£½çµæœä»£ç¢¼ï¼Œä¸¦è²¼çµ¦è€å¸«ï¼</p>
                        <button onclick="copyResultCode()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 flex items-center gap-2 mx-auto">
                            <i data-lucide="copy"></i> è¤‡è£½çµæœä»£ç¢¼
                        </button>
                    </div>

                    <div class="border-t pt-6">
                        <h3 class="font-bold text-xl text-slate-800 mb-4">ç­”éŒ¯é¡Œç›®æª¢è¨</h3>
                        <div id="wrong-answers-list" class="space-y-4 text-left">
                            <!-- Wrong answers -->
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </main>

    <!-- Overlay for Win (Game) -->
    <div id="win-overlay" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm text-center pop-in border-4 border-yellow-400">
            <div class="text-6xl mb-4">ğŸ†</div>
            <h2 class="text-3xl font-black text-indigo-900 mb-2">æ­å–œå®Œæˆï¼</h2>
            <p class="text-slate-600 mb-6">ä½ å·²ç¶“æŒæ¡äº†æ’å…¥æ’åºæ³•çš„ç²¾é«“ï¼</p>
            <div class="bg-slate-100 p-4 rounded-xl mb-6">
                <div class="flex justify-between border-b border-slate-300 pb-2 mb-2">
                    <span>éŒ¯èª¤æ¬¡æ•¸</span>
                    <span id="result-errors" class="font-bold text-red-500">0</span>
                </div>
                <div class="flex justify-between">
                    <span>è©•åƒ¹</span>
                    <span id="result-rank" class="font-bold text-emerald-600">S ç´šå¤§å¸«</span>
                </div>
            </div>
            <div class="flex gap-2 justify-center">
                <button onclick="closeOverlay()" class="bg-slate-200 text-slate-700 font-bold px-6 py-3 rounded-xl hover:bg-slate-300">é—œé–‰</button>
                <button onclick="initGame(); closeOverlay()" class="bg-indigo-600 text-white font-bold px-6 py-3 rounded-xl hover:bg-indigo-700 shadow-lg border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1">å†ç©ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <script>
        // Init Icons
        lucide.createIcons();

        // --- GLOBAL STATE ---
        const DEMO_DATA = [8, 7, 9, 6, 2];
        const GAME_DATA = [6, 9, 2, 5, 4]; // Default easy
        
        let demoState = {
            arr: [...DEMO_DATA],
            i: 1, // Start from index 1 (rule 1)
            j: 0,
            key: null,
            status: 'IDLE', // IDLE, PICK_KEY, COMPARE, SHIFT, INSERT, NEXT
            timer: null
        };

        let gameState = {
            arr: [],
            mode: 'drag', // 'drag' or 'algo'
            sortedCount: 1, // Index boundary between sorted/unsorted
            currentKeyIdx: 1, // Original index of current key
            tempKeyVal: null,
            compareIdx: 0,
            errors: 0,
            algoStatus: 'PICK', // PICK, COMPARE, SHIFT
            selectedGap: null
        };

        // --- QUIZ DATA ---
        const QUIZ_DATA = [
            // True/False
            { id: 1, type: 'tf', q: 'æ’å…¥æ’åºæ³•æœƒå…ˆå°‡è³‡æ–™åˆ†æˆã€Œå·²æ’åºã€èˆ‡ã€Œæœªæ’åºã€å…©å€‹å€åŸŸã€‚', ans: 'T', rationale: 'æ­£ç¢ºã€‚é€™æ˜¯æ’å…¥æ’åºçš„åŸºæœ¬æ¦‚å¿µã€‚' },
            { id: 2, type: 'tf', q: 'æ’å…¥æ’åºåœ¨æ¯ä¸€è¼ªæ’åºæ™‚ï¼Œæœƒå¾ã€Œæœªæ’åºå€çš„æœ€å¾Œä¸€å€‹ã€é–‹å§‹æ¯”è¼ƒã€‚', ans: 'F', rationale: 'éŒ¯èª¤ã€‚æ˜¯å¾ã€Œæœªæ’åºå€çš„ç¬¬ä¸€å€‹ã€é–‹å§‹ã€‚' },
            { id: 3, type: 'tf', q: 'åœ¨æ’å…¥æ’åºä¸­ï¼Œå·²æ’åºå€çš„è³‡æ–™åœ¨æ¯ä¸€è¼ªçµæŸå¾Œéƒ½ä¿æŒç”±å°åˆ°å¤§çš„é †åºã€‚', ans: 'T', rationale: 'æ­£ç¢ºã€‚å·²æ’åºå€å§‹çµ‚ä¿æŒæœ‰åºã€‚' },
            { id: 4, type: 'tf', q: 'æ’å…¥æ’åºå°±åƒæ•´ç†æ’²å…‹ç‰Œï¼Œä¸€æ¬¡åªè™•ç†ä¸€å¼µç‰Œã€‚', ans: 'T', rationale: 'æ­£ç¢ºã€‚é€™æ˜¯æœ€å¸¸ç”¨çš„é¡æ¯”ã€‚' },
            { id: 5, type: 'tf', q: 'æ’å…¥æ’åºæ³•åœ¨æ¯”è¼ƒæ™‚ï¼Œæ˜¯ç”±å·¦å¾€å³é€²è¡Œæ¯”è¼ƒã€‚', ans: 'F', rationale: 'éŒ¯èª¤ã€‚ä¸€èˆ¬æ˜¯ç”±å³å¾€å·¦ï¼ˆå¾å·²æ’åºå€çš„æœ€å¤§å€¼é–‹å§‹æ¯”ï¼‰ã€‚' },
            { id: 6, type: 'tf', q: 'æ’å…¥æ’åºå®Œæˆæ’åºæ™‚ï¼Œä¸€å…±éœ€è¦ N æ¬¡æ’å…¥å‹•ä½œï¼ˆN ç‚ºè³‡æ–™ç­†æ•¸ï¼‰ã€‚', ans: 'F', rationale: 'éŒ¯èª¤ã€‚ç¬¬1å€‹è¦–ç‚ºå·²æ’åºï¼Œæ•…åªéœ€ N-1 è¼ªã€‚' },
            
            // Choice
            { id: 7, type: 'mc', q: 'æ’å…¥æ’åºä¸­ï¼Œæ¯ä¸€è¼ªè¦æ‹¿ä¾†æ’å…¥çš„æ•¸å€¼ç¨±ç‚ºä»€éº¼ï¼Ÿ', opts: ['pivot', 'key', 'index', 'max'], ans: 'key' },
            { id: 8, type: 'mc', q: 'æ’å…¥æ’åºä¸­ï¼Œkey æœƒèˆ‡å“ªä¸€å€‹å€åŸŸçš„è³‡æ–™é€²è¡Œæ¯”è¼ƒï¼Ÿ', opts: ['æœªæ’åºå€', 'å…¨éƒ¨è³‡æ–™', 'å·²æ’åºå€', 'éš¨æ©Ÿé¸æ“‡'], ans: 'å·²æ’åºå€' },
            { id: 9, type: 'mc', q: 'è‹¥è¦é€²è¡Œã€Œç”±å°åˆ°å¤§ã€çš„æ’å…¥æ’åºï¼Œç•¶å·¦é‚Šçš„æ•¸å­—æ¯” key å¤§æ™‚ï¼Œæ­£ç¢ºçš„å‹•ä½œæ˜¯ï¼Ÿ', opts: ['ç›´æ¥äº¤æ›', 'å¿½ç•¥ä¸ç®¡', 'å°‡å·¦é‚Šçš„æ•¸å­—å¾€å³ç§»', 'å°‡ key ä¸Ÿæ‰'], ans: 'å°‡å·¦é‚Šçš„æ•¸å­—å¾€å³ç§»' },
            { id: 10, type: 'mc', q: 'æ’å…¥æ’åºæœ€ç¬¦åˆä¸‹åˆ—å“ªä¸€å€‹ç”Ÿæ´»æƒ…å¢ƒï¼Ÿ', opts: ['æ´—ç‰Œ', 'æŠ½ç±¤', 'æ•´ç†æ’²å…‹ç‰Œæ‰‹ç‰Œ', 'æ“²éª°å­'], ans: 'æ•´ç†æ’²å…‹ç‰Œæ‰‹ç‰Œ' },
            { id: 11, type: 'mc', q: 'æ’å…¥æ’åºæ¯ä¸€è¼ªæ’åºå®Œæˆå¾Œï¼Œä¸‹åˆ—å“ªä¸€é …æ˜¯æ­£ç¢ºçš„ï¼Ÿ', opts: ['æœªæ’åºå€è®Šå¤§', 'å·²æ’åºå€è®Šå°', 'å·²æ’åºå€å¢åŠ ä¸€å€‹å…ƒç´ ', 'è³‡æ–™é †åºæœƒäº‚æ‰'], ans: 'å·²æ’åºå€å¢åŠ ä¸€å€‹å…ƒç´ ' },
            { id: 12, type: 'mc', q: 'è‹¥åŸå§‹è³‡æ–™æœ‰ 6 ç­†ï¼Œæ’å…¥æ’åºæœ€å¤šéœ€è¦å¹¾è¼ªæ’å…¥ï¼Ÿ', opts: ['4', '5', '6', '7'], ans: '5' },
            { id: 13, type: 'mc', q: 'æ’å…¥æ’åºä¸­ï¼Œç•¶æ¯”è¼ƒåˆ°å“ªä¸€ç¨®æƒ…æ³æ™‚æœƒåœæ­¢å¾€å·¦æ¯”è¼ƒï¼Ÿ', opts: ['å·¦é‚Šçš„æ•¸å­—æ¯” key å¤§', 'å·¦é‚Šçš„æ•¸å­—æ¯” key å°æˆ–ç­‰æ–¼ key', 'é‚„æ²’æ¯”è¼ƒå®Œ', 'é‚„æœ‰æœªæ’åºè³‡æ–™'], ans: 'å·¦é‚Šçš„æ•¸å­—æ¯” key å°æˆ–ç­‰æ–¼ key' },
            { id: 14, type: 'mc', q: 'ä¸‹åˆ—å“ªä¸€é …ä¸æ˜¯æ’å…¥æ’åºçš„ç‰¹é»ï¼Ÿ', opts: ['æ’åºéç¨‹æ˜¯é€æ­¥å®Œæˆ', 'æ¯ä¸€è¼ªåªè™•ç†ä¸€å€‹ key', 'éœ€è¦å¤§é‡é¡å¤–è¨˜æ†¶é«”', 'å·²æ’åºå€æœƒé€æ¼¸æ“´å¤§'], ans: 'éœ€è¦å¤§é‡é¡å¤–è¨˜æ†¶é«”' },

            // Fill
            { id: 15, type: 'fill', q: 'æ’å…¥æ’åºä¸€é–‹å§‹ï¼Œæœƒå…ˆå°‡ç¬¬ ______ å€‹è³‡æ–™è¦–ç‚ºã€Œå·²æ’åºã€ã€‚', ans: ['1', 'ä¸€', 'ç¬¬ä¸€å€‹', '1å€‹'] },
            { id: 16, type: 'fill', q: 'æ’å…¥æ’åºä¸­ï¼Œæœªæ’åºå€çš„ç¬¬ ______ å€‹å…ƒç´ æœƒè¢«é¸ç‚º keyã€‚', ans: ['1', 'ä¸€', 'ç¬¬ä¸€å€‹', '1å€‹'] },
            { id: 17, type: 'fill', q: 'æ’å…¥æ’åºåœ¨æ¯”è¼ƒæ™‚ï¼Œæ˜¯ç”± ______ å¾€ ______ æ–¹å‘é€²è¡Œæ¯”è¼ƒã€‚ï¼ˆå¡«æ–¹å‘ï¼Œä¾‹å¦‚ï¼šä¸Š ä¸‹ï¼‰', ans: ['å³å·¦', 'å³ å·¦', 'å³å¾€å·¦', 'å³åˆ°å·¦', 'å¾Œå‰', 'å¾Œ å‰'] },
            { id: 18, type: 'fill', q: 'ç•¶å·²æ’åºå€ä¸­çš„æ•¸å­—æ¯” key ______ æ™‚ï¼Œå°±å¿…é ˆå°‡è©²æ•¸å­—å¾€å³ç§»ã€‚', ans: ['å¤§', 'bigger', '>'] },
            { id: 19, type: 'fill', q: 'æ’å…¥æ’åºå®Œæˆä¸€è¼ªå¾Œï¼Œå·²æ’åºå€çš„è³‡æ–™ç­†æ•¸æœƒå¢åŠ  ______ ç­†ã€‚', ans: ['1', 'ä¸€', '1ç­†'] },
            { id: 20, type: 'fill', q: 'æ’å…¥æ’åºå¸¸ç”¨ã€Œæ•´ç† ______ ç‰Œã€ä¾†å¹«åŠ©ç†è§£æ¼”ç®—æ³•æµç¨‹ã€‚', ans: ['æ’²å…‹', 'æ’²å…‹ç‰Œ'] }
        ];

        let quizState = {
            student: { class: '', num: '', name: '' },
            answers: {}, // id: value
            startTime: null
        };

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-yellow-400', 'text-indigo-900', 'shadow-md', 'scale-105');
                btn.classList.add('text-indigo-100');
            });
            const activeBtn = document.getElementById(`btn-${tab}`);
            activeBtn.classList.remove('text-indigo-100');
            activeBtn.classList.add('bg-yellow-400', 'text-indigo-900', 'shadow-md', 'scale-105');

            if(tab === 'play') initGame();
            if(tab === 'learn') resetDemo();
        }

        // --- HELPER RENDER CARD ---
        function createCardHTML(val, type='normal', label='') {
            let classes = "w-16 h-24 md:w-20 md:h-28 rounded-xl flex flex-col items-center justify-center font-black text-2xl md:text-3xl border-2 card-shadow transition-all-300 relative select-none ";
            
            if (type === 'sorted') classes += "bg-white border-emerald-500 text-emerald-700";
            else if (type === 'unsorted') classes += "bg-slate-200 border-slate-400 text-slate-500";
            else if (type === 'key') classes += "bg-yellow-100 border-yellow-500 text-yellow-700 z-20";
            else if (type === 'comparing') classes += "bg-blue-100 border-blue-500 text-blue-700 scale-105";
            else if (type === 'empty') classes += "bg-slate-100 border-dashed border-slate-300 opacity-50";
            
            return `
                <div class="${classes}" id="card-${val}">
                    <span>${val}</span>
                    ${label ? `<span class="absolute -top-3 text-[10px] bg-slate-800 text-white px-2 py-0.5 rounded-full">${label}</span>` : ''}
                </div>
            `;
        }

        // --- SECTION 1: DEMO LOGIC ---
        
        function renderDemo() {
            const container = document.getElementById('demo-container');
            container.innerHTML = '';
            
            const { arr, i, j, key, status } = demoState;

            arr.forEach((val, idx) => {
                let type = 'unsorted';
                let label = '';
                
                if (idx < i) type = 'sorted';
                
                if (status === 'PICK_KEY' && idx === i) {
                    type = 'key';
                    label = 'Key';
                } else if (status === 'COMPARE') {
                    if (idx === j) type = 'comparing';
                    if (idx === j+1) type = 'key';
                }

                if (status === 'IDLE') {
                    if(idx < i) type = 'sorted';
                    else type = 'unsorted';
                }

                if (status !== 'IDLE' && status !== 'NEXT' && status !== 'PICK_KEY') {
                    if (idx === j) { type = 'comparing'; label = 'æ¯”è¼ƒä¸­'; }
                    if (idx === j + 1 && arr[idx] === key) { type = 'key'; label = 'Key'; }
                }

                const div = document.createElement('div');
                div.innerHTML = createCardHTML(val, type, label);
                container.appendChild(div.firstElementChild);
            });
        }

        function resetDemo() {
            clearInterval(demoState.timer);
            demoState = {
                arr: [...DEMO_DATA],
                i: 1, j: 0, key: null, status: 'IDLE', timer: null
            };
            document.getElementById('demo-play-btn').innerHTML = '<i data-lucide="play" class="w-4 h-4"></i> æ’­æ”¾';
            document.getElementById('demo-message').innerText = "æº–å‚™é–‹å§‹ï¼šåŸå§‹è³‡æ–™ [ " + DEMO_DATA.join(", ") + " ]";
            renderDemo();
            lucide.createIcons();
        }

        function toggleDemoAutoPlay() {
            if (demoState.timer) {
                clearInterval(demoState.timer);
                demoState.timer = null;
                document.getElementById('demo-play-btn').innerHTML = '<i data-lucide="play" class="w-4 h-4"></i> æ’­æ”¾';
            } else {
                demoState.timer = setInterval(stepDemo, 1000); // 1 sec per step
                document.getElementById('demo-play-btn').innerHTML = '<i data-lucide="pause" class="w-4 h-4"></i> æš«åœ';
                stepDemo(); // run one immediately
            }
            lucide.createIcons();
        }

        function stepDemo() {
            const msg = document.getElementById('demo-message');
            const s = demoState;

            if (s.status === 'DONE') {
                clearInterval(s.timer);
                s.timer = null;
                document.getElementById('demo-play-btn').innerHTML = '<i data-lucide="rotate-ccw" class="w-4 h-4"></i> é‡ç½®';
                lucide.createIcons();
                return;
            }

            switch(s.status) {
                case 'IDLE':
                    if (s.i >= s.arr.length) {
                        s.status = 'DONE';
                        msg.innerText = "æ’åºå®Œæˆï¼æ‰€æœ‰ç¶ è‰²éƒ½å·²å°±ä½ã€‚";
                        renderDemo();
                        return;
                    }
                    s.status = 'PICK_KEY';
                    s.key = s.arr[s.i];
                    s.j = s.i - 1;
                    msg.innerText = `ç¬¬ ${s.i} è¼ªï¼šæ‹¿å‡ºæœªæ’åºç¬¬ 1 å€‹æ•¸å­— ${s.key} ç•¶ä½œ Key`;
                    break;

                case 'PICK_KEY':
                    s.status = 'COMPARE';
                    msg.innerHTML = `æº–å‚™é–‹å§‹æ¯”è¼ƒï¼šKey (${s.key}) vs å·¦é‚Šçš„ ${s.arr[s.j]}`;
                    break;

                case 'COMPARE':
                    if (s.j >= 0 && s.arr[s.j] > s.key) {
                        msg.innerHTML = `<span class="text-blue-600">${s.arr[s.j]}</span> æ¯” Key (${s.key}) å¤§ï¼Œå¾€å³ç§»ä¸€æ ¼ï¼`;
                        s.status = 'SHIFT';
                    } else {
                        s.status = 'INSERT';
                        msg.innerText = (s.j < 0) ? "æ¯”åˆ°æœ€å·¦é‚Šäº†ï¼Œæ’å…¥ï¼" : `é‡åˆ° ${s.arr[s.j]} æ¯” Key å°ï¼Œæ’å…¥åœ¨å®ƒå¾Œé¢ï¼`;
                    }
                    break;

                case 'SHIFT':
                    s.arr[s.j + 1] = s.arr[s.j];
                    s.arr[s.j] = s.key; 
                    s.j--;
                    s.status = 'COMPARE';
                    break;

                case 'INSERT':
                    s.arr[s.j + 1] = s.key;
                    s.i++;
                    s.status = 'IDLE';
                    msg.innerText = `æ’å…¥å®Œæˆã€‚æº–å‚™ä¸‹ä¸€è¼ª...`;
                    break;
            }
            renderDemo();
        }


        // --- SECTION 2: GAME LOGIC ---

        function initGame() {
            gameState.arr = [...GAME_DATA];
            gameState.sortedCount = 1;
            gameState.currentKeyIdx = 1; 
            gameState.errors = 0;
            gameState.mode = gameState.mode || 'drag'; 
            gameState.algoStatus = 'PICK';
            gameState.compareIdx = 0;
            gameState.j = 0;
            gameState.key = 0;

            document.getElementById('game-errors').innerText = 0;
            document.getElementById('game-round').innerText = `1/${gameState.arr.length - 1}`;
            document.getElementById('game-feedback').innerText = "";

            renderGame();
        }

        function setGameMode(mode) {
            gameState.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.remove('bg-indigo-600', 'text-white', 'ring-4', 'ring-indigo-300', 'border-indigo-800');
                b.classList.add('bg-slate-200', 'text-slate-600', 'border-slate-400');
            });
            const active = document.getElementById(`mode-${mode}`);
            active.classList.remove('bg-slate-200', 'text-slate-600', 'border-slate-400');
            active.classList.add('bg-indigo-600', 'text-white', 'ring-4', 'ring-indigo-300', 'border-indigo-800');

            if (mode === 'drag') {
                document.getElementById('game-title').innerText = "æ‹–æ›³æŒ‘æˆ°";
                document.getElementById('game-instruction').innerText = "é»æ“Šé»ƒè‰² Keyï¼Œå†é»æ“Šç¶ è‰²å€åŸŸä¸­çš„æ­£ç¢ºç©ºä½æ’å…¥ã€‚";
                document.getElementById('algo-controls').classList.add('hidden');
            } else {
                document.getElementById('game-title').innerText = "æ¼”ç®—æ³•æ“ä½œ";
                document.getElementById('game-instruction').innerText = "æ‰®æ¼” CPUï¼Œä¸€æ­¥æ­¥åŸ·è¡Œï¼šæ¯”è¼ƒ â†’ å³ç§» â†’ æ’å…¥ã€‚";
                document.getElementById('algo-controls').classList.remove('hidden');
            }
            initGame();
        }

        function renderGame() {
            const container = document.getElementById('game-container');
            container.innerHTML = '';

            if (gameState.sortedCount >= gameState.arr.length) {
                container.innerHTML = `<div class="text-center"><div class="text-6xl animate-bounce">ğŸ‰</div></div>`;
                showWinOverlay();
                return;
            }

            const keyVal = gameState.arr[gameState.sortedCount]; 
            const arr = gameState.arr;

            if (gameState.mode === 'drag') {
                let sortedHTML = '<div class="flex items-center bg-emerald-50 p-3 rounded-xl border border-emerald-200 gap-1">';
                sortedHTML += `<div onclick="handleGapClick(-1)" class="w-4 h-24 hover:bg-yellow-200 cursor-pointer rounded transition-colors border-2 border-transparent hover:border-yellow-400 gap-slot" data-idx="-1"></div>`;

                for(let i=0; i<gameState.sortedCount; i++) {
                    sortedHTML += createCardHTML(arr[i], 'sorted');
                    sortedHTML += `<div onclick="handleGapClick(${i})" class="w-4 h-24 hover:bg-yellow-200 cursor-pointer rounded transition-colors border-2 border-transparent hover:border-yellow-400 gap-slot" data-idx="${i}"></div>`;
                }
                sortedHTML += '</div>';

                let unsortedHTML = '<div class="flex items-center gap-2 border-l-4 border-slate-300 pl-4">';
                unsortedHTML += `<div class="cursor-grab hover:scale-105 transition-transform" onclick="highlightGaps()">${createCardHTML(keyVal, 'key', 'KEY')}</div>`;
                
                for(let i=gameState.sortedCount+1; i<arr.length; i++) {
                    unsortedHTML += createCardHTML(arr[i], 'unsorted');
                }
                unsortedHTML += '</div>';

                container.innerHTML = sortedHTML + unsortedHTML;
            } 
            else {
                let html = '';
                arr.forEach((val, idx) => {
                    let type = 'unsorted';
                    let label = '';
                    if (idx < gameState.sortedCount) type = 'sorted';
                    if (gameState.algoStatus === 'PICK' && idx === gameState.sortedCount) {
                        type = 'key'; label = 'Key?';
                    }
                    else if (gameState.algoStatus !== 'PICK') {
                        if (idx === gameState.sortedCount) type = 'key';
                        if (idx === gameState.compareIdx && gameState.algoStatus === 'COMPARE') type = 'comparing';
                    }
                    html += createCardHTML(val, type, label);
                });
                container.innerHTML = html;
            }
        }

        function highlightGaps() {
            document.querySelectorAll('.gap-slot').forEach(el => {
                el.classList.add('bg-yellow-100', 'animate-pulse');
            });
            document.getElementById('game-feedback').innerText = "ç¾åœ¨é»æ“Šå·¦é‚Šç¶ è‰²å€åŸŸä¸­çš„ç©ºéš™ä¾†æ’å…¥ï¼";
        }

        function handleGapClick(gapIndex) {
            const keyVal = gameState.arr[gameState.sortedCount];
            const sortedSubArr = gameState.arr.slice(0, gameState.sortedCount);
            
            let correctIndex = 0;
            for(let i=0; i<sortedSubArr.length; i++) {
                if(keyVal > sortedSubArr[i]) {
                    correctIndex = i + 1;
                }
            }
            const userChosenIndex = gapIndex + 1;

            if (userChosenIndex === correctIndex) {
                playFeedback(true, "æ­£ç¢ºï¼æ’å…¥ä½ç½®å®Œç¾ï¼");
                gameState.arr.splice(gameState.sortedCount, 1);
                gameState.arr.splice(correctIndex, 0, keyVal);
                gameState.sortedCount++;
                document.getElementById('game-round').innerText = `${Math.min(gameState.sortedCount, gameState.arr.length-1)}/${gameState.arr.length-1}`;
                setTimeout(() => { renderGame(); }, 800);
            } else {
                gameState.errors++;
                document.getElementById('game-errors').innerText = gameState.errors;
                if (userChosenIndex < correctIndex) {
                    playFeedback(false, `éŒ¯èª¤ï¼${keyVal} æ¯”å·¦é‚Šçš„æŸäº›æ•¸å­—é‚„å¤§å–”ï¼`);
                } else {
                    playFeedback(false, `éŒ¯èª¤ï¼${keyVal} æ¯”å³é‚Šçš„æŸäº›æ•¸å­—é‚„å°å–”ï¼`);
                }
            }
        }

        function algoAction(action) {
            const feedback = document.getElementById('game-feedback');
            const arr = gameState.arr;
            
            if (gameState.algoStatus === 'PICK') {
                gameState.key = arr[gameState.sortedCount]; 
                gameState.j = gameState.sortedCount - 1;    
                gameState.algoStatus = 'COMPARE';
                renderGame();
                if (action !== 'compare') {
                    playFeedback(false, "ç¬¬ä¸€æ­¥å¿…é ˆå…ˆã€Œæ¯”è¼ƒã€ï¼");
                    return;
                }
            }

            const j = gameState.j;
            const key = gameState.key;

            if (action === 'compare') {
                gameState.compareIdx = j; 
                renderGame();
                if (j >= 0 && arr[j] > key) {
                    feedback.innerText = `${arr[j]} > ${key}ï¼Œæ‡‰è©²å³ç§»ï¼`;
                    gameState.expectedAction = 'shift';
                } else {
                    feedback.innerText = (j<0) ? "æ¯”åˆ°é ­äº†ï¼Œæ’å…¥ï¼" : `${arr[j]} <= ${key}ï¼Œæ‰¾åˆ°ä½ç½®ï¼Œæ’å…¥ï¼`;
                    gameState.expectedAction = 'insert';
                }
            }
            else if (action === 'shift') {
                if (gameState.expectedAction === 'shift') {
                     arr[j+1] = arr[j];
                     arr[j] = key; 
                     gameState.j--;
                     gameState.algoStatus = 'COMPARE'; 
                     playFeedback(true, "å³ç§»æˆåŠŸï¼å†æ¯”ä¸‹ä¸€å€‹ã€‚");
                     renderGame();
                     gameState.expectedAction = null; 
                } else {
                    playFeedback(false, "ä¸èƒ½å³ç§»ï¼");
                    gameState.errors++;
                }
            }
            else if (action === 'insert') {
                if (gameState.expectedAction === 'insert') {
                    arr[j+1] = key; 
                    gameState.sortedCount++;
                    gameState.algoStatus = 'PICK';
                    document.getElementById('game-round').innerText = `${Math.min(gameState.sortedCount, gameState.arr.length-1)}/${gameState.arr.length-1}`;
                    playFeedback(true, "æ’å…¥æˆåŠŸï¼ä¸‹ä¸€è¼ªã€‚");
                    renderGame();
                } else {
                    playFeedback(false, "é‚„æ²’æ‰¾åˆ°æ­£ç¢ºä½ç½®ï¼");
                    gameState.errors++;
                }
            }
            document.getElementById('game-errors').innerText = gameState.errors;
        }

        function playFeedback(isSuccess, text) {
            const el = document.getElementById('game-feedback');
            el.innerText = text;
            el.className = isSuccess ? "mt-4 text-center font-bold text-lg h-8 text-emerald-600 animate-pulse" : "mt-4 text-center font-bold text-lg h-8 text-red-500 animate-shake";
        }

        function showWinOverlay() {
            const overlay = document.getElementById('win-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            const err = gameState.errors;
            document.getElementById('result-errors').innerText = err;
            let rank = "C";
            if(err === 0) rank = "S ç´šå¤§å¸«";
            else if(err <= 2) rank = "A ç´šé«˜æ‰‹";
            else if(err <= 5) rank = "B ç´šç©å®¶";
            document.getElementById('result-rank').innerText = rank;
        }

        function closeOverlay() {
            const overlay = document.getElementById('win-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }

        // --- QUIZ LOGIC ---

        function startQuiz() {
            const c = document.getElementById('std-class').value;
            const n = document.getElementById('std-num').value;
            const nm = document.getElementById('std-name').value;

            if(!c || !n || !nm) {
                alert("è«‹å®Œæ•´å¡«å¯« ç­ç´šã€åº§è™Ÿã€å§“åï¼");
                return;
            }

            quizState.student = { class: c, num: n, name: nm };
            quizState.startTime = new Date();
            
            document.getElementById('display-std-info').innerText = `${c}ç­ ${n}è™Ÿ ${nm}`;
            
            // Switch view
            document.getElementById('student-login').classList.add('hidden');
            document.getElementById('quiz-content').classList.remove('hidden');

            renderQuiz();
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-questions-container');
            container.innerHTML = '';

            // Group questions by type for headings
            const tfQuestions = QUIZ_DATA.filter(q => q.type === 'tf');
            const mcQuestions = QUIZ_DATA.filter(q => q.type === 'mc');
            const fillQuestions = QUIZ_DATA.filter(q => q.type === 'fill');

            // Render True/False
            container.innerHTML += `<div class="bg-indigo-50 p-4 rounded-xl border-l-4 border-indigo-500"><h3 class="font-bold text-xl text-indigo-900">ä¸€ã€æ˜¯éé¡Œ (æ¯é¡Œ5åˆ†)</h3></div>`;
            tfQuestions.forEach((q, idx) => {
                container.innerHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="font-bold text-lg mb-4 text-slate-800"><span class="text-indigo-600 mr-2">${q.id}.</span> ${q.q}</div>
                        <div class="flex gap-6">
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-slate-50 w-32 border hover:border-indigo-300">
                                <input type="radio" name="q-${q.id}" value="T" class="w-6 h-6 text-indigo-600"> <span class="font-bold text-emerald-600">O æ˜¯</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-slate-50 w-32 border hover:border-indigo-300">
                                <input type="radio" name="q-${q.id}" value="F" class="w-6 h-6 text-indigo-600"> <span class="font-bold text-red-500">X å¦</span>
                            </label>
                        </div>
                    </div>
                `;
            });

            // Render MC
            container.innerHTML += `<div class="bg-indigo-50 p-4 rounded-xl border-l-4 border-indigo-500 mt-8"><h3 class="font-bold text-xl text-indigo-900">äºŒã€é¸æ“‡é¡Œ (æ¯é¡Œ5åˆ†)</h3></div>`;
            mcQuestions.forEach((q, idx) => {
                let optsHTML = '';
                q.opts.forEach(opt => {
                    optsHTML += `
                        <label class="flex items-center gap-3 cursor-pointer p-3 rounded-lg hover:bg-slate-50 border border-transparent hover:border-indigo-200 transition-colors">
                            <input type="radio" name="q-${q.id}" value="${opt}" class="w-5 h-5 text-indigo-600">
                            <span class="text-slate-700">${opt}</span>
                        </label>
                    `;
                });
                container.innerHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="font-bold text-lg mb-4 text-slate-800"><span class="text-indigo-600 mr-2">${q.id}.</span> ${q.q}</div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${optsHTML}
                        </div>
                    </div>
                `;
            });

            // Render Fill
            container.innerHTML += `<div class="bg-indigo-50 p-4 rounded-xl border-l-4 border-indigo-500 mt-8"><h3 class="font-bold text-xl text-indigo-900">ä¸‰ã€å¡«ç©ºé¡Œ (æ¯é¡Œ5åˆ†)</h3></div>`;
            fillQuestions.forEach((q, idx) => {
                container.innerHTML += `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="font-bold text-lg mb-4 text-slate-800"><span class="text-indigo-600 mr-2">${q.id}.</span> ${q.q}</div>
                        <div>
                            <input type="text" name="q-${q.id}" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" class="w-full md:w-1/2 p-3 border-2 border-slate-300 rounded-lg focus:border-indigo-500 outline-none">
                        </div>
                    </div>
                `;
            });
        }

        function submitQuiz() {
            // Collect answers
            let score = 0;
            let wrongList = [];
            
            QUIZ_DATA.forEach(q => {
                let userAns = '';
                if (q.type === 'fill') {
                    const el = document.querySelector(`input[name="q-${q.id}"]`);
                    userAns = el ? el.value.trim() : '';
                } else {
                    const el = document.querySelector(`input[name="q-${q.id}"]:checked`);
                    userAns = el ? el.value : '';
                }

                quizState.answers[q.id] = userAns;

                // Check correctness
                let isCorrect = false;
                if (q.type === 'tf') {
                    isCorrect = (userAns === q.ans);
                } else if (q.type === 'mc') {
                    isCorrect = (userAns === q.ans);
                } else if (q.type === 'fill') {
                    // Normalize user ans and correct ans array for loose matching
                    const normalizedUser = userAns.replace(/\s+/g, '').toLowerCase();
                    isCorrect = q.ans.some(a => a.replace(/\s+/g, '').toLowerCase() === normalizedUser);
                }

                if (isCorrect) {
                    score += 5;
                } else {
                    // Prepare wrong list info
                    let correctDisplay = Array.isArray(q.ans) ? q.ans[0] : (q.ans === 'T' ? 'O æ˜¯' : (q.ans === 'F' ? 'X å¦' : q.ans));
                    let rationale = q.rationale || '';
                    wrongList.push({
                        id: q.id,
                        q: q.q,
                        user: userAns || '(æœªä½œç­”)',
                        correct: correctDisplay,
                        rationale: rationale
                    });
                }
            });

            // Show Results
            document.getElementById('final-score').innerText = score;
            
            // Generate Code
            const timeStr = quizState.startTime.toLocaleString('zh-TW');
            const std = quizState.student;
            const codeObj = {
                u: `${std.class}-${std.num}-${std.name}`,
                s: score,
                t: timeStr,
                hash: btoa(encodeURIComponent(`${std.name}-${score}-${Math.random()}`)).substring(0, 10) // Fake hash for visual
            };
            const resultString = `ã€æ¸¬é©—çµæœæ†‘è­‰ã€‘\nå§“åï¼š${std.class}ç­ ${std.num}è™Ÿ ${std.name}\nåˆ†æ•¸ï¼š${score} åˆ†\næ™‚é–“ï¼š${timeStr}\né©—è­‰ç¢¼ï¼š${codeObj.hash}`;
            
            document.getElementById('result-code-box').innerText = resultString;

            // Render Wrong Answers
            const wrongContainer = document.getElementById('wrong-answers-list');
            wrongContainer.innerHTML = '';
            if (wrongList.length === 0) {
                wrongContainer.innerHTML = '<div class="text-emerald-600 font-bold text-center">å¤ªç¥äº†ï¼å…¨å°ï¼ğŸ’¯</div>';
            } else {
                wrongList.forEach(w => {
                    wrongContainer.innerHTML += `
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <div class="font-bold text-slate-800 mb-1">ç¬¬ ${w.id} é¡Œï¼š${w.q}</div>
                            <div class="text-sm text-red-600">ä½ çš„å›ç­”ï¼š${w.user}</div>
                            <div class="text-sm text-emerald-600 font-bold">æ­£ç¢ºç­”æ¡ˆï¼š${w.correct}</div>
                            ${w.rationale ? `<div class="text-xs text-slate-500 mt-1 bg-white p-2 rounded">è§£æï¼š${w.rationale}</div>` : ''}
                        </div>
                    `;
                });
            }

            document.getElementById('quiz-result').classList.remove('hidden');
            document.getElementById('quiz-result').classList.add('flex');
        }

        function closeQuizResult() {
             document.getElementById('quiz-result').classList.add('hidden');
             document.getElementById('quiz-result').classList.remove('flex');
        }

        function copyResultCode() {
            const text = document.getElementById('result-code-box').innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("å·²è¤‡è£½ï¼è«‹è²¼çµ¦è€å¸«ã€‚");
            });
        }

        // Start Up
        renderDemo();
    </script>
</body>
</html>
